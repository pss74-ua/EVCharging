version: '3.8'

services:
  # 1. Servicio de Coordinación para Kafka (Zookeeper) - NECESARIO
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    hostname: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000

  # 2. Servicio del Broker de Kafka (Gestor de Colas)
  kafka:
    image: confluentinc/cp-kafka:7.5.0 # Usamos una imagen de Confluent, más fácil de configurar con Zookeeper
    container_name: kafka
    hostname: kafka
    ports:
      - "9092:9092"
    depends_on:
      - zookeeper # Dependencia reactivada, es crucial
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 # Conexión al servicio 'zookeeper'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_INTERN_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

  # 3. Módulo CENTRAL (Servidor de Sockets y Lógica de Negocio)
  central:
    build:
      context: ./EV_Central
    container_name: ev_central
    ports:
      - "8080:8080"
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      CENTRAL_PORT: 8080
    depends_on:
      - kafka
    # command: ["python3", "EV_Central.py", "8080", "kafka:29092"]
    command: ["/bin/bash", "-c", "tail -f /dev/null"]

  # 4. Módulo CP - ENGINE (Simulación de Suministro)
  cp_engine_1:
    build:
      context: ./EV_CP_E
    container_name: ev_cp_e_1
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      MONITOR_HOST: ev_cp_m_1
      MONITOR_PORT: 8081
    depends_on:
      - kafka
      - central
    command: ["python3", "EV_CP_E.py", "kafka:29092"]

  # 5. Módulo CP - MONITOR (Cliente de Sockets y Chequeo de Salud)
  cp_monitor_1:
    build:
      context: ./EV_CP_M
    container_name: ev_cp_m_1
    ports:
      - "8081:8081"
    environment:
      CENTRAL_HOST: ev_central
      CENTRAL_PORT: 8080
      CP_ID: "ALC1"
      ENGINE_PORT: 8081
    depends_on:
      - central
    command: ["python3", "EV_CP_M.py", "ev_cp_e_1", "8080", "ALC1"]

  # 6. Módulo DRIVER (Solicitudes de Recarga)
  driver_1:
    build:
      context: ./EV_Driver
    container_name: ev_driver_1
    environment:
      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      DRIVER_ID: 101
    depends_on:
      - kafka
      - central
    # command: ["python3", "EV_Driver.py", "kafka:29092", "101"]
    command: ["/bin/bash", "-c", "tail -f /dev/null"]