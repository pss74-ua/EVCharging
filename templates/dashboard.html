<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>EV Charging Dashboard</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        h1 { text-align: center; color: #333; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        
        /* Colores seg√∫n estado */
        .status-IDLE { border-top: 5px solid #28a745; } /* Verde */
        .status-CHARGING { border-top: 5px solid #007bff; background-color: #e6f2ff; } /* Azul */
        .status-AUTHORIZED { border-top: 5px solid #17a2b8; } /* Cyan */
        .status-FAULTED { border-top: 5px solid #dc3545; background-color: #ffe6e6; } /* Rojo */
        .status-STOPPED { border-top: 5px solid #fd7e14; } /* Naranja */
        .status-DISCONNECTED { border-top: 5px solid #6c757d; opacity: 0.7; } /* Gris */

        .badge { display: inline-block; padding: 5px 10px; border-radius: 15px; color: white; font-weight: bold; font-size: 0.9em; }
        .bg-IDLE { background: #28a745; }
        .bg-CHARGING { background: #007bff; }
        .bg-AUTHORIZED { background: #17a2b8; }
        .bg-FAULTED { background: #dc3545; }
        .bg-STOPPED { background: #fd7e14; }
        .bg-DISCONNECTED { background: #6c757d; }
    </style>
</head>
<body>

    <h1>Panel de Control - Charging Points</h1>
    <div id="cp-container" class="grid">
        </div>

    <div id="status-container"></div>

    <h2 style="text-align: center; margin-top: 40px; color: #333;">√öltimos Eventos del Sistema</h2>
    <div style="width: 90%; margin: 0 auto; overflow-x: auto;">
        <table border="1" style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
            <thead>
                <tr style="background-color: #007bff; color: white;">
                    <th style="padding: 10px;">Hora</th>
                    <th style="padding: 10px;">Origen (IP)</th>
                    <th style="padding: 10px;">Entidad</th>
                    <th style="padding: 10px;">Evento</th>
                    <th style="padding: 10px;">Detalles</th>
                </tr>
            </thead>
            <tbody id="audit-table-body">
                </tbody>
        </table>
    </div>

    <script>
        // URL de tu API Central
        const API_URL = '/api/v1/status';
        const API_AUDIT = "/api/v1/audit";

        async function fetchStatus() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                const container = document.getElementById('cp-container');
                container.innerHTML = ''; // Limpiar

                const listaCPs = Array.isArray(data) ? data : (data.cp_list || []);

                listaCPs.forEach(cp => {
                    const statusClass = `status-${cp.status || 'DISCONNECTED'}`;
                    const bgClass = `bg-${cp.status || 'DISCONNECTED'}`;
                    
                    const regText = (cp.is_registered == 1) ? 
                        '<span style="color:green; font-size:0.8em">‚úî Registrado</span>' : 
                        '<span style="color:red; font-size:0.8em">‚ùå No Registrado</span>';

                    //const driverHtml = cp.current_driver ? 
                    //    `<p style="color: #007bff; font-weight: bold;">üöó ${cp.current_driver}</p>` : '';

                    const html = `
                        <div class="card ${statusClass}">
                            <div>${regText}</div> 
                            <h2>${cp.cp_id}</h2>
                            <p><strong>${cp.location}</strong> ${cp.weather_temperature}¬∫C</p>
                            <span class="badge ${bgClass}">${cp.status || 'OFFLINE'}</span>
                            <p>${cp.price_kwh} ‚Ç¨/kWh</p>
                    `;
                    container.innerHTML += html;
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Refrescar cada 2 segundos
        setInterval(fetchStatus, 2000);
        fetchStatus();

        // NUEVA FUNCI√ìN PARA LA TABLA
        async function updateAuditTable() {
            try {
                const response = await fetch(API_AUDIT);
                const logs = await response.json();
                const tbody = document.getElementById('audit-table-body');
                tbody.innerHTML = '';

                logs.forEach(log => {
                    const row = `
                        <tr>
                            <td style="padding: 8px;">${log.timestamp}</td>
                            <td style="padding: 8px;">${log.source_ip}</td>
                            <td style="padding: 8px;">${log.entity_id || '-'}</td>
                            <td style="padding: 8px; font-weight: bold;">${log.event_type}</td>
                            <td style="padding: 8px; font-size: 0.9em; color: #555;">${log.details || ''}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            } catch (error) {
                console.error("Error audit logs:", error);
            }
        }

        // Refresco cada 2 segundos
        setInterval(updateAuditTable, 2000);
        updateAuditTable();
    </script>
</body>
</html>